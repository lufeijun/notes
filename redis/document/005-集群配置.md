# 集群配置


## 集群分布式方案

### 客户端分区方案

![客户端集群方案](./img/003 "客户端集群方案")

原理：由客户端决定数据被存储到那个 redis 节点：采用哈希算法将 redis 数据的 key 进行散列，通过 hash 函数，将 key 分布到不同的 redis 节点上

* 优点：不用第三方中间件，分区逻辑可控，配置简单，各个节点之间无关联关系，
* 缺点：客户端无法动态增删服务节点，需要自行维护数据的分发逻辑，客户端之间 **无连接共享**，会造成连接浪费


### 代理分区方案

![代理集群方案](./img/004 "代理集群方案")


原理：客户端发送请求到一个代理组件，代理解析客户端的数据，并将请求转发到正确的节点，最后将数据返回

* 优点：简化了客户端分布式逻辑，客户端透明接入，切换成本低，代理的 转发 和 存储 分离
* 缺点：多了一层代理层，加重了架构部署的复杂度和性能损耗

代理分区方案实现：twemproxy 和 codis


### 查询路由方案

![代理集群方案](./img/005 "代理集群方案")


原理：客户端随机的请求任意一个 redis 实例，然后 redis 将请求转发给正确的 redis 节点，redis cluster 实现了一种混合式的查询路由，但是并不是直接将请求从一个 redis 节点转发到另一个 redis 节点，而是在客户端的帮助下重定向到正确的 redis 节点

* 优点：无中心节点，数据按照**槽**存储在多个 redis 实例上，可以平滑的进行节点扩展|缩容，支持高可用和自动故障转移，运维成本低
* 缺点：缺乏监控管理；依赖 smart client ；Failover 节点的检测过慢，不如中心节点 zookeeper 及时；Gossip 消息具有一定的开销。无法根据统计区分**冷热数据**






## 数据分布方案


### 数据分布理论

分布式数据库需要将数据集按照分区规则映射到多个节点上。

* 哈希分区：离散度好、数据分布与业务无关，无法顺序访问
* 顺序分区：离散度容易倾斜、数据分布与业务相关、可以顺序访问


### 节点取余分区

使用特定的数据，如 redis 的key 或者 用户id，再根据节点数量 N，使用公式：hash( key )%N 计算出值，决定其存储的节点

![代理集群方案](./img/006 "代理集群方案")


* 优点：简单性，常用于数据库的分库分表规则，需要按照业务量提前做好规划，扩容时通常采用翻倍扩展，避免数据映射全部被打乱，导致全量迁移
* 缺点：当节点数据变化时，数据映射结果会出现变动，需要进行数据迁移


### 一致性哈希分区

![代理集群方案](./img/007 "代理集群方案")

一致性哈希可以很好的解决稳定性问题，可以将所有的存储点排列在首尾相接的 hash 环上，每个 key 在计算 hash 后会顺时针找到临接的存储节点进行存放，当有节点加入或者退出的时，仅影响该节点在 hash 环上顺时针相邻的后续节点


* 优点：新增、删除节点影响相邻节点
* 缺点：加减节点会造成哈希环中部分数据无法命中，当节点过少时，新增或者删除节点影响有些大


### 虚拟槽分区

![代理集群方案](./img/008 "代理集群方案")

利用哈希空间，使用分散度良好的哈希函数把所有数据映射到一个固定范围的整数集合，整数定义为 槽( slot )，槽是集群内数据管理和迁移的基本单位，



## redis 的数据分区

redis cluster 采用虚拟槽分区，所有键根据哈希函数映射到 0 ~ 16383 整数槽内，计算公式：slot = CRC16( key ) % 16383，每个节点负责维护一部分槽以及槽内所映射的数据


### redis 虚拟槽分区特点

* 解耦数据和节点之间的关系，简化了扩容和缩容
* 节点自身维护槽的映射关系，不需要客户端或者代理服务维护槽分区元数据
* 支持节点、槽、键之间的映射查询，类似路由表，用于数据路由、在线伸缩


### 功能限制

* key 批量操作支持有限
* key 事务操作支持有限
* key 作为数据分区的最小粒度
* 不支持多数据库空间
* 复制结构只支持一层




### 搭建

* 开启 redis 实例

```
# 端口
# bind 127.0.0.1
protected-mode yes
port 6386



# 通用参数
daemonize yes
pidfile "/path/cluster/pid/redis-6386.pid"
loglevel notice
logfile "/path/cluster/log/redis-6386.log"

# 持久化
dir "/path/cluster/data/redis-6386"

appendonly yes
appendfilename "appendonly_6386.aof"
appendfsync everysec

# 密码
requirepass 123456

################################ REDIS CLUSTER  ###############################
cluster-enabled yes
cluster-config-file /path/cluster/conf/cluster-6386.conf
cluster-node-timeout 10000

```

修改对应监听端口，开启 6 个 redis 实例


* 使用命令开启集群

```
./src/redis-cli --cluster create 192.168.78.204:6381 192.168.78.204:6382 192.168.78.204:6383 192.168.78.204:6384 192.168.78.204:6385 192.168.78.204:6386 --cluster-replicas 1 -a 123456
```



 



# 参考连接

https://juejin.im/post/5b8fc5536fb9a05d2d01fb11#heading-0
https://www.cnblogs.com/zhoujinyi/p/11606935.html  命令







