# innodb 

  表结构部分 和 表数据部分

  

# 知识点回顾

  innodb 中的数据都是用 B+ 树的数据结构组织的，并且以数据页的形式存储在磁盘上的。
  一个数据页大小为 16 kb，初始的 ibd 文件大小默认是 96 kb。所以当新建一个表时，产生的 ibd 文件的大小为 112 kb，之后随着数据的增长，以 16 kb 的梯度进行增加



# 数据删除

  ex：一个数据页上存储着 3 条记录， R3 、R4 、R5，

  删除记录：当删除 R4 时，innodb 引擎只会把 R4 的数据标记为删除，如果再次有 R3 ~ R5 之间的数据插入时，才会复用 R4 的位置
  整页删除：如果 R3 、R4 、R5 都删除了，innodb 会将该页标记为删除，这样，整个页的内存就可以重新复用了

  
  这些可以被复用但是仍未被复用的空间，可以成为 空洞，

  空洞的形成：
    1、删除数据，
    2、插入数据，
      主要是插入顺序是随机的，ex：插入 R3、R5、R6，这三个记录占用一个数据页，但是又要插入 R4 ，这样会触发分页现象，导致出现一些空洞，
      所以，每个数据表都需要主键，并且按照主键进行插入，保证空洞不多

# 空洞的问题

  1、数据页上的真是记录不多，在进行 DML 操作时，可能会读取更多的数据页到内存


# 处理数据表空洞问题
  

## 重建表
  alter table A engine=innoDB，在 5.6 之后，此流程变成 online 模式的，即在进行重建时，仍然可以对外提供服务

  step：
    1、建立一个临时文件，扫描 A 主键所有的数据页
    2、用数据页中表A的记录生成 B+ 树，存储到临时文件中
    3、生成临时文件的过程中，将所有的对 A 的操作记录在一个日志文件中，
    4、临时文件生成之后，将日志文件中的操作应用到临时文件，得到一个逻辑上与 A 相同的数据文件，
    4、用临时文件替换表 A 的数据文件

  在执行 alter 语句时，会自动加上 MDL (元数据锁) 写锁，但是在复制数据时会退化为 读锁，就是为了实现 online 的功能



# 参数设置

  1、innodb_file_per_table：5.6。6 之后的版本，默认值为 on
    on：每个 innodb 表数据存储在一个以 .ibd 文件中
    off：表的数据放在系统共享表空间
    
    最好设置为 on，这样，在 drop table 的时候，mysql 就可以马上回收改变对应的 .ibd 数据文件所占的磁盘


  2、mysql8.0 之前，表结构保存在 .frm 文件中，之后的版本，则已经允许把表结构定义放在系统数据表中了




# mysql 术语

  1、DDL DML DCL
    DDL ：数据定义语句，created|drop|alter
    DML ：数据库操作语句，增删改查
    DCL ：数据控制语句，权限相关语句

  2、查看 mysql data 数据存储路径
    show global variables like "%datadir%"

  3、对比
    alter table：也就是 recreate ，重建，
    analyze table：只是对表的索引信息做重新统计，没有修改数据，加 MDL 读锁
    optimize table：recreate + analyze
    truncate table : drop + create