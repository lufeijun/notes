
# 主备延迟

  三个时间点
    1、主库 A 执行完一个事务，写入 binlog，时刻 T1
    2、之后传给备库 B，B 节后完这个 binlog 的时刻 T2 
    3、备库 B 执行完这个事务，时刻 T3

  主备延迟时间，即为 T3 - T1
  
  SQL 在备库上执行 show slave status，有一列 seconds_behind_master ，表示当前主备延迟情况

  延迟，本质上是，备库消耗 relay log 的能力 比 主库产生的 binlog 能力差，

## 主备延迟来源

  1、备库所在机器的性能太差

  2、备库的读压力过大

  3、大事务导致的延迟



# 主备切换的两个策略


## 可靠性优先策略

  在双 M 结构下：  
  1、判断备库 B 现在的 seconds_behind_master ，如果小于某个值( 5s )，则继续，否则接着等待  
  2、把主库 A 改为 readonly， 
  3、判断备库 B 的 seconds_behind_master ，直到为 0  
  4、把 B 库改为可写入的
  5、业务请求切换到 B 库

  有一段时间，对外不可用的，步骤 2 到 步骤 5，


## 可用性优先策略

  就是直接修改，会造成一些数据不一致现象；



